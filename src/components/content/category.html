{% if locale === "de" %}
    {% set data = datocms_data_de %}
{% else %}
    {% set data = datocms_data_en %}
{% endif %}

<script>
    window.locale = "{{ locale }}";
    window.providers = {{ data.allProviders | dump | safe }};
    window.mainCategories = {{ data.allMainCategories | dump | safe }};
    window.subCategories = {{ data.allSubcategories | dump | safe }};
</script>

<div x-data="sortableList()" class="container mx-auto">

    <div class="flex gap-4 p-4">

        <!-- Filter by Main Category -->
        <select id="mainCategory" x-model="selectedMainCategory" @change="filterProviders()" class="flex items-center justify-between rounded bg-white p-2 ring-1 ring-gray-300">
            <option value="">All Types</option>
            <template x-for="category in mainCategories" :key="category.id">
                <option :value="category.name" x-text="category.name + ' (' + countProvidersByMainCategory(category.name) + ')'"></option>
            </template>
        </select>

        <!-- Filter by Subcategory -->
        <select id="subCategory" x-model="selectedSubCategory" @change="filterProviders()" class="flex items-center justify-between rounded bg-white p-2 ring-1 ring-gray-300">
            <option value="">All Categories</option>
            <template x-for="subcategory in subCategories" :key="subcategory.id">
                <option :value="subcategory.name" x-text="subcategory.name + ' (' + countProvidersBySubCategory(subcategory.name) + ')'"></option>
            </template>
        </select>

        <!-- Sort dropdown -->
        <select id="sortOrder" x-model="sortOrder" @change="sortProviders()" class="flex items-center justify-between rounded bg-white p-2 ring-1 ring-gray-300">
            <option value="ratingDesc">Best rated</option>
            <option value="publishedAtDesc">Recent updated</option>
            <option value="firstPublishedAtDesc">Newest</option>
        </select>

        <!-- Search input -->
        <input type="text" placeholder="Search by name..." x-model="searchQuery" @input="filterProviders()" class="w-full p-2 border border-gray-300 rounded"/>
    </div>

    <!-- Iterate through the filtered and sorted items with Alpine.js -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 p-4">
        <template x-for="provider in sortedAndFilteredProviders" :key="provider.id">
            <div>
                <!-- Include the provider card component -->
                <a :href="(window.locale === 'de' ? '/de/' : '/') + provider.slug"
                class="bg-gray-500 flex flex-col gap-4 items-center justify-center overflow-hidden px-4 md:px-8 text-center rounded-xl h-32 md:h-48 hover:ring-2 ring-orange-500 active:scale-95 transition-all group relative bg-cover">

        
                    <!-- Provider Name -->
                    <h2 class="text-lg md:text-2xl text-white font-bold drop-shadow-provider line-clamp-2 z-10" x-text="provider.name"></h2>
        
                    <!-- Main Category -->
                    <div class="bg-white rounded-lg py-1 px-2 absolute top-2 left-2 text-[10px] md:text-sm z-10" x-text="provider.mainCategory.name"></div>
        
                    <!-- AI Rating with Dynamic Colors -->
                    <div 
                        class="font-bold rounded-lg py-1 px-2 absolute top-2 right-2 text-[10px] md:text-sm z-10"
                        :class="{
                            'bg-red-500 text-red-950 ring-1 ring-offset-1 ring-offset-red-100 ring-red-500': provider.aiRating <= 3,
                            'bg-orange-500 text-orange-950 ring-1 ring-offset-1 ring-offset-orange-100 ring-orange-500': provider.aiRating > 3 && provider.aiRating <= 4,
                            'bg-lime-500 text-lime-950 ring-1 ring-offset-1 ring-offset-lime-100 ring-lime-500': provider.aiRating > 4 && provider.aiRating <= 4.5,
                            'bg-green-500 text-green-950 ring-1 ring-offset-1 ring-offset-green-100 ring-green-500': provider.aiRating > 4.5 && provider.aiRating <= 5
                        }"
                    >
                        <span x-text="provider.aiRating.toFixed(1)"></span>
                    </div>
        
                    <!-- Provider Image -->
                    <template x-if="provider.photos && provider.photos.length > 0">
                        <img
                            class="absolute inset-0 h-full w-full z-0 transition-transform scale-100 group-hover:scale-125 object-cover brightness-75"
                            :src="provider.photos[0].responsiveImage.src"
                            :alt="provider.name + ' cover'"
                        />
                    </template>
                </a>
            </div>
        </template>
    </div>
 

</div>

<script>
    function sortableList() {
        return {
            providers: window.providers,
            mainCategories: window.mainCategories,
            subCategories: window.subCategories,
            sortOrder: 'ratingDesc', // Default sort order
            searchQuery: '',
            selectedMainCategory: '',
            selectedSubCategory: '',
            sortedProviders: [],
            sortedAndFilteredProviders: [],

            // Count the number of providers for each main category
            countProvidersByMainCategory(categoryName) {
                return this.providers.filter(provider => provider.mainCategory.name === categoryName).length;
            },

            // Count the number of providers for each subcategory
            countProvidersBySubCategory(subCategoryName) {
                return this.providers.filter(provider => provider.subCategories.some(sub => sub.name === subCategoryName)).length;
            },

            // Initialize the sorted list
            init() {
                this.sortProviders(); // Sort the providers initially
            },

            // Sorting function based on sortOrder
            sortProviders() {
                switch (this.sortOrder) {
                    case 'ratingAsc':
                        this.sortedProviders = this.providers.sort((a, b) => a.aiRating - b.aiRating);
                        break;
                    case 'ratingDesc':
                        this.sortedProviders = this.providers.sort((a, b) => b.aiRating - a.aiRating);
                        break;
                    case 'publishedAtAsc':
                        this.sortedProviders = this.providers.sort((a, b) => new Date(a._publishedAt) - new Date(b._publishedAt));
                        break;
                    case 'publishedAtDesc':
                        this.sortedProviders = this.providers.sort((a, b) => new Date(b._publishedAt) - new Date(a._publishedAt));
                        break;
                    case 'firstPublishedAtAsc':
                        this.sortedProviders = this.providers.sort((a, b) => new Date(a._firstPublishedAt) - new Date(b._firstPublishedAt));
                        break;
                    case 'firstPublishedAtDesc':
                        this.sortedProviders = this.providers.sort((a, b) => new Date(b._firstPublishedAt) - new Date(a._firstPublishedAt));
                        break;
                }
                this.filterProviders(); // Call filter function after sorting
            },

            // Filtering function based on the search query and category filters
            filterProviders() {
                this.sortedAndFilteredProviders = this.sortedProviders.filter((provider) => {
                    let matchesSearch = provider.name.toLowerCase().includes(this.searchQuery.toLowerCase());
                    let matchesMainCategory = this.selectedMainCategory === '' || provider.mainCategory.name === this.selectedMainCategory;
                    let matchesSubCategory = this.selectedSubCategory === '' || provider.subCategories.some(sub => sub.name === this.selectedSubCategory);
                    return matchesSearch && matchesMainCategory && matchesSubCategory;
                });
            }
        }
    }
</script>