{% if locale === "de" %}
    {% set data = datocms_data_de %}
{% else %}
    {% set data = datocms_data_en %}
{% endif %}

<div x-data="sortableList()" class="container mx-auto px-4">

    <div class="xl:flex justify-between gap-4 px-4 pt-4 text-sm xl:text-base">
        <div class="xl:flex justify-between gap-2">
            {% include "../search/maincategory.html" %}
            {% include "../search/subcategory.html" %}
        </div>
    </div>

    <div class="flex justify-end w-full mb-4">
        {% include "../search/sorting.html" %}
    </div>

    <!-- Iterate through the filtered and sorted items with Alpine.js -->
    <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
        {% include "../search/providercard.html" %}
    </div>
 
    <!-- No Results Message and Reset Button -->
    <div x-show="sortedAndFilteredProviders.length === 0" class="text-center p-4">
        <p class="text-lg font-bold">No results found. Try adjusting your filters.</p>
        <button @click="resetFilters()" class="bg-red-500 text-white px-4 py-2 rounded-full mt-2">
            Reset All Filters
        </button>
    </div>

</div>

<script>
function sortableList() {
    return {
        providers: window.providers,
        mainCategories: window.mainCategories,
        subCategories: window.subCategories,
        sortOrder: 'publishedAtDesc',  // Default sort order
        searchQuery: '',          // Default search query
        selectedMainCategory: '', // Default main category filter
        selectedSubCategory: '',  // Default subcategory filter
        sortedProviders: [],
        sortedAndFilteredProviders: [],

        // Initialize the sorted list, also read URL parameters if present
        init() {
            this.readUrlParams();  // Read URL parameters on page load
            this.sortProviders();  // Sort the providers initially
            this.filterProviders(); // Ensure the filters are applied properly
        },

        // Read filter/sort/search parameters from URL
        readUrlParams() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('search')) {
                this.searchQuery = params.get('search');
            }
            if (params.has('mainCategory')) {
                this.selectedMainCategory = params.get('mainCategory');
            }
            if (params.has('subCategory')) {
                this.selectedSubCategory = params.get('subCategory');
            }
            if (params.has('sortOrder')) {
                this.sortOrder = params.get('sortOrder');
            }
        },

        // Update URL parameters whenever filters change
        updateUrlParams() {
            const params = new URLSearchParams();

            if (this.searchQuery) params.set('search', this.searchQuery);
            if (this.selectedMainCategory) params.set('mainCategory', this.selectedMainCategory);
            if (this.selectedSubCategory) params.set('subCategory', this.selectedSubCategory);
            if (this.sortOrder) params.set('sortOrder', this.sortOrder);

            const newUrl = `${window.location.pathname}?${params.toString()}`;
            history.replaceState(null, '', newUrl);  // Update the URL without reloading the page
        },

        // Reset all filters, search, and sorting
        resetFilters() {
            this.searchQuery = '';          // Reset search query
            this.selectedMainCategory = ''; // Reset main category filter
            this.selectedSubCategory = '';  // Reset subcategory filter
            this.sortOrder = 'publishedAtDesc';   // Reset to default sort order
            this.sortProviders();           // Re-sort and re-filter the providers
            this.updateUrlParams();         // Update URL parameters
        },

        // Sorting function
        sortProviders() {
            switch (this.sortOrder) {
                case 'ratingAsc':
                    this.sortedProviders = this.providers.sort((a, b) => a.aiRating - b.aiRating);
                    break;
                case 'ratingDesc':
                    this.sortedProviders = this.providers.sort((a, b) => b.aiRating - a.aiRating);
                    break;
                case 'publishedAtAsc':
                    this.sortedProviders = this.providers.sort((a, b) => new Date(a._publishedAt) - new Date(b._publishedAt));
                    break;
                case 'publishedAtDesc':
                    this.sortedProviders = this.providers.sort((a, b) => new Date(b._publishedAt) - new Date(a._publishedAt));
                    break;
                case 'firstPublishedAtAsc':
                    this.sortedProviders = this.providers.sort((a, b) => new Date(a._firstPublishedAt) - new Date(b._firstPublishedAt));
                    break;
                case 'firstPublishedAtDesc':
                    this.sortedProviders = this.providers.sort((a, b) => new Date(b._firstPublishedAt) - new Date(a._firstPublishedAt));
                    break;
            }
            this.filterProviders(); // Call filter function after sorting
        },

        // Filtering function
        filterProviders() {
            this.sortedAndFilteredProviders = this.sortedProviders.filter((provider) => {
                let matchesSearch = provider.name.toLowerCase().includes(this.searchQuery.toLowerCase());
                let matchesMainCategory = this.selectedMainCategory === '' || provider.mainCategory.name === this.selectedMainCategory;
                let matchesSubCategory = this.selectedSubCategory === '' || provider.subCategories.some(sub => sub.name === this.selectedSubCategory);
                return matchesSearch && matchesMainCategory && matchesSubCategory;
            });
        },

        // Count the number of providers for each main category
        countProvidersByMainCategory(categoryName) {
            return this.providers.filter(provider => provider.mainCategory.name === categoryName).length;
        },

        // Count the number of providers for each subcategory
        countProvidersBySubCategory(subCategoryName) {
            return this.providers.filter(provider => provider.subCategories.some(sub => sub.name === subCategoryName)).length;
        }
    }
}

</script>